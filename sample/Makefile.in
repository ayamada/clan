# @AC_MSG_1@
# @AC_MSG_2@
# @AC_MSG_3@
# @AC_MSG_4@
# @AC_MSG_5@
# @AC_MSG_6@

# (TODO: translate explain from japanese to english)
# (TODO: 日本語のコメントを英語に直してまわる)

EMPTY :=
SPACE := $(EMPTY) $(EMPTY)


JAVA    := @JAVA_PATH@
JAVAC   := @JAVAC_PATH@
#JAR     := @JAR_PATH@
LEIN    := @LEIN_PATH@
#MVN     := @MVN_PATH@
ADB     := @ADB_PATH@
WGET    := @WGET_PATH@
UNZIP   := @UNZIP_PATH@
#PERL    := @PERL_PATH@
#EXEWRAP := @EXEWRAP_PATH@
L4J     := @L4J_PATH@
L4J_DIR = $(dir $(L4J))
L4J_JAR = $(L4J_DIR)launch4j.jar



PROJECT_GROUPID    := @PROJECT_GROUPID@
PROJECT_ARTIFACTID := @PROJECT_ARTIFACTID@
PROJECT_VERSION    := @PROJECT_VERSION@
PROJECT_NAME       := @PROJECT_NAME@
PROJECT_SHORT_NAME := @PROJECT_SHORT_NAME@

PROJECT_DESKTOP_GROUPID    := @PROJECT_DESKTOP_GROUPID@
PROJECT_ANDROID_GROUPID    := @PROJECT_ANDROID_GROUPID@
PROJECT_ANDROID_VERSIONCODE := @PROJECT_ANDROID_VERSIONCODE@

CLAN_GROUPID    := @CLAN_GROUPID@
CLAN_ARTIFACTID := @CLAN_ARTIFACTID@
CLAN_VERSION    := @CLAN_VERSION@
CLAN_NAME       := @CLAN_NAME@
CLAN_CLOJURE_VERSION := @CLAN_CLOJURE_VERSION@
CLAN_LIBGDX_VERSION  := @CLAN_LIBGDX_VERSION@
CLAN_ANDROID_VERSION := @CLAN_ANDROID_VERSION@
CLAN_NEKO_VERSION    := @CLAN_NEKO_VERSION@






LAYOUT_MAINACTIVITY_ROOT      := android/src-java
LAYOUT_DESKTOP_ROOT           := desktop/src-java
LAYOUT_MAINACTIVITY_DIR       := $(LAYOUT_MAINACTIVITY_ROOT)/$(subst .,/,$(PROJECT_ANDROID_GROUPID))
LAYOUT_DESKTOP_DIR            := $(LAYOUT_DESKTOP_ROOT)/$(subst .,/,$(PROJECT_DESKTOP_GROUPID))

LIBGDX_ZIP := libgdx-$(CLAN_LIBGDX_VERSION).zip
LIBGDX_URL := http://libgdx.googlecode.com/files/$(LIBGDX_ZIP)






.PHONY: help clean dep jar apk force layout clan assets res release desktop android run

help:
	@echo "sorry, see clan/README.rst"






$(LIBGDX_ZIP):
	$(WGET) $(LIBGDX_URL)

tmp/libgdx/gdx.jar: $(LIBGDX_ZIP)
	mkdir -p tmp/libgdx
	cd tmp/libgdx && $(UNZIP) ../../$(LIBGDX_ZIP)
	touch tmp/libgdx/gdx.jar

.dep-libgdx-done: tmp/libgdx/gdx.jar
	cd tmp/libgdx && for f in *.jar; do \
		cd ../../clan/depinst && $(LEIN) localrepo install ../../tmp/libgdx/$$f com.badlogic.gdx/$${f%%.jar} $(CLAN_LIBGDX_VERSION) || break 0; \
	done
	cd clan/depinst && $(LEIN) localrepo install ../../tmp/libgdx/extensions/gdx-tools/gdx-tools.jar com.badlogic.gdx/gdx-tools $(CLAN_LIBGDX_VERSION)
	touch .dep-libgdx-done

dep-libgdx: .dep-libgdx-done

dep-libgdx-clean:
	rm -rf tmp/libgdx
	rm -f .dep-libgdx-done



desktop/assets/pack.png: .dep-libgdx-done
	cd clan/tpack && $(LEIN) run -m com.badlogic.gdx.tools.imagepacker.TexturePacker2 ../../textures ../../desktop/assets

ta: ta-clean desktop/assets/pack.png

ta-clean:
	rm -f desktop/assets/pack.{atlas,png}

update-resources-for-release:
	rm -rf desktop/target/resources
	mkdir -p desktop/target/resources
	cp -a desktop/assets desktop/target/resources

add-lib-to-resources:
	rm -rf android/target/resources
	mkdir -p android/target/resources/lib
	cp -a desktop/assets android/target/resources
	cp -r tmp/libgdx/armeabi-v7a android/target/resources/lib
	cp -r tmp/libgdx/armeabi android/target/resources/lib

add-gdx-res:
	#cd tmp && rm -rf com
	#cd tmp && jar xf libgdx/gdx.jar
	#mkdir -p android/target/gdx-res/com/badlogic/gdx/utils
	#cp tmp/com/badlogic/gdx/utils/arial-15.* android/target/gdx-res/com/badlogic/gdx/utils
	true



#dep: .dep-libgdx-done .dep-neko-done
dep: .dep-libgdx-done

#depclean: dep-libgdx-clean dep-neko-clean
depclean: dep-libgdx-clean
	rm -rf tmp




.layout-done:
	mkdir -p $(LAYOUT_MAINACTIVITY_DIR)
	cp layout/MainActivity.java $(LAYOUT_MAINACTIVITY_DIR)
	mkdir -p $(LAYOUT_DESKTOP_DIR)
	cp layout/Desktop.java $(LAYOUT_DESKTOP_DIR)
	touch .layout-done

layout: .layout-done

layout-clean:
	rm -rf $(LAYOUT_MAINACTIVITY_ROOT)
	rm -rf $(LAYOUT_DESKTOP_ROOT)
	rm -f .layout-done




repl: .dep-libgdx-done .layout-done
	$(MAKE) ta
	export CLAN_TARGET=desktop CLAN_DEBUG=1 && cd desktop && $(LEIN) with-profile repl repl

desktop/target/$(PROJECT_ARTIFACTID)-devpack.jar: .dep-libgdx-done .layout-done
	$(MAKE) ta
	export CLAN_TARGET=desktop CLAN_DEBUG=1 && cd desktop && $(LEIN) with-profile devpack uberjar

devpack: desktop/target/$(PROJECT_ARTIFACTID)-devpack.jar

# NB: 素早い動作確認の為に、再コンパイル無しに実行できるバイナリを生成している
#     (src部をコンパイル対象に含めずにコンパイルし、あとで-cpで読み込む)
# NB: javaのclasspath区切り文字の為にインチキをしている
run: desktop/target/$(PROJECT_ARTIFACTID)-devpack.jar
	export CLAN_TARGET=desktop CLAN_DEBUG=1 && cd desktop && $(JAVA) -cp '../src:target/$(PROJECT_ARTIFACTID)-devpack.jar:;../src;target/$(PROJECT_ARTIFACTID)-devpack.jar' $(PROJECT_DESKTOP_GROUPID).Desktop



target/$(PROJECT_ARTIFACTID).jar: .dep-libgdx-done .layout-done
	cd desktop && $(LEIN) clean
	$(MAKE) ta update-resources-for-release
	export CLAN_TARGET=desktop CLAN_RELEASE=1 && cd desktop && $(LEIN) with-profile pack,release uberjar
	mkdir -p target
	cp desktop/target/$(PROJECT_ARTIFACTID).jar target
	cd desktop && $(LEIN) clean

release-jar: target/$(PROJECT_ARTIFACTID).jar

release-exe: target/$(PROJECT_ARTIFACTID).jar
	cd target && ln -sf $(L4J_DIR)bin $(L4J_DIR)head $(L4J_DIR)w32api .
	cd target && $(JAVA) -jar $(L4J_JAR) ../l4j/l4j.xml

release-exe-if-exists:
	if [ x != x$(L4J) ]; then \
		$(MAKE) release-exe; \
	fi
	true

# TODO: ↑のlaunch4jは失敗しても終了コード0を返す。stdoutの出力を見て判定するように直す
# 成功時
# launch4j: Compiling resources
# launch4j: Linking
# launch4j: Wrapping
# launch4j: Successfully created path/to/hoge.exe
# 失敗時(これ以外にもある)
# launch4j: java.io.FileNotFoundException: hoge (No such file or directory)


desktop-clean:
	cd desktop && $(LEIN) clean






# TODO: nekoコンパイル回りは一旦コメントアウト(可能ならleinでまとめてコンパイルしたい)
#NEKO_COMPILE_JARS := clan/neko/target/dependency/*.jar
# NB: ↓は即座には評価されないらしい。
#       (即座に評価されてしまうとNEKO_COMPILE_JARSが空になってしまう)
#       詳細は以下を参照 http://d.hatena.ne.jp/m-hiyama/20071024/1193202017
#DEP_COMPILE_CPS_NEKO = ../../$(subst $(SPACE),:../../,$(wildcard $(NEKO_COMPILE_JARS)))

# neko中でコンパイルが必要なものを列挙
#NEKO_COMPILE_TARGETS := neko.compilation
#NEKO_COMPILE_TARGETS = $(shell find tmp/neko/orig/neko | grep '\.clj$$' | $(PERL) -ne 'chomp; s|^tmp/neko/orig/(.*)\.clj$$|$$1|; s|/|.|g; s|_|-|g; print "$$_ "' && echo)


# NB: .dep-neko-src-doneが分離しているのは、↓で参照しているNEKO_COMPILE_*変数の判定タイミングが、makeターゲット実行中には存在しない為。これを一緒にしてしまうとNEKO_COMPILE_*が空になる。
#.dep-neko-src-done:
#	mkdir -p tmp/neko/classes/neko/ui/adapters tmp/neko/orig
#	cd clan/neko && $(MVN) dependency:copy-dependencies
#	cd tmp/neko/orig && $(JAR) xf ../../../clan/neko/target/dependency/neko-$(CLAN_NEKO_VERSION).jar
#	cp tmp/neko/orig/neko/ui/adapters/*.class tmp/neko/classes/neko/ui/adapters
#	touch .dep-neko-src-done
# TODO: ↑の*.classのコピーは、nekoのバージョンが上がったらもっと増やさないといけなくなる。対策が必要。

#.dep-neko-done: .dep-neko-src-done
#	cd tmp/neko && for x in $(NEKO_COMPILE_TARGETS); do \
#		$(JAVA) -cp ./classes:$(DEP_COMPILE_CPS_NEKO) clojure.main -e "(compile '$$x)" || break 0; \
#	done
#	cd tmp/neko && $(JAR) cvf neko.jar -C classes .
#	cd tmp/neko && $(MVN) install:install-file -Dfile=neko.jar -DgroupId=neko -DartifactId=neko -Dclassifier=compiled -Dversion=$(CLAN_NEKO_VERSION) -Dpackaging=jar -DgeneratePom=true -DcreateChecksum=true
#	touch .dep-neko-done

#dep-neko: .dep-neko-done

#dep-neko-clean:
#	cd clan/neko && $(MVN) clean
#	rm -rf tmp/neko
#	rm -f .dep-neko-src-done
#	rm -f .dep-neko-done






# NB: $(ADB) のチェックをしてもよい。しかし、なしでも問題ないと思う
# TODO: ~/.lein/profiles.clj に、keystore等の設定がされているかのチェック。
# 以前はmvn -Prelease packageに失敗した場合に以下の文章を出していた
# (echo "you dont edit settings.xml yet? please see README.rst and grep 'settings.xml'." && false)

.droid-build-done: .dep-libgdx-done .layout-done
	$(MAKE) ta add-lib-to-resources add-gdx-res
	export CLAN_TARGET=android CLAN_DEBUG=1 && cd android && $(LEIN) with-profile devpack droid build
	touch .droid-build-done

.droid-apk-done: .droid-build-done
	export CLAN_TARGET=android CLAN_DEBUG=1 && cd android && $(LEIN) with-profile devpack droid apk
	touch .droid-apk-done

.droid-install-done: .droid-apk-done
	export CLAN_TARGET=android CLAN_DEBUG=1 && cd android && $(LEIN) with-profile devpack droid install
	touch .droid-install-done

# lein droid build
android-build: .droid-build-done

# lein droid install
android-install: .droid-install-done

# lein droid run
android-run: .droid-install-done
	export CLAN_TARGET=android CLAN_DEBUG=1 && cd android && $(LEIN) with-profile devpack droid run

# lein do droid forward-port, droid repl
android-repl: .droid-install-done
	export CLAN_TARGET=android CLAN_DEBUG=1 && cd android && $(LEIN) with-profile devpack do droid run, droid forward-port, droid repl

android-clean:
	cd android && $(LEIN) clean
	rm -rf android/gen
	rm -f .droid-*-done

release-apk: .dep-libgdx-done .layout-done
	cd android && $(LEIN) clean
	$(MAKE) ta add-lib-to-resources add-gdx-res
	export CLAN_TARGET=android CLAN_RELEASE=1 && cd android && $(LEIN) with-profile pack,release do droid release build, droid release apk
	mkdir -p target
	cp android/target/$(PROJECT_ARTIFACTID).apk target
	cd android && $(LEIN) clean

release-apk-if-exists:
	if [ x != x$(ADB) ]; then \
		$(MAKE) release-apk; \
	fi
	true

release: release-jar release-exe-if-exists release-apk-if-exists

release-clean:
	rm -rf target






clean: desktop-clean android-clean layout-clean ta-clean

ac-clean:
	rm -f config.log config.status
	rm -rf @AC_GENERATED_FILES@

distclean: depclean clean ac-clean release-clean

maintainer-clean: distclean
	rm -f $(LIBGDX_ZIP)




env:
	env | sort

force: ;



